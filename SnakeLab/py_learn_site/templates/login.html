<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Вход • SnakeLab</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy-1:#0b1220; --navy-2:#0e1a33; --navy-3:#132445; --navy-4:#1b2e59;
      --ink:#0b1220; --muted:#667188; --border:#e6e8ec; --card:#ffffff;
      --btn:#0f1b34; --btn-ink:#fff; --accent:#4f7cff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#e7ecff;background:#0a0f1f}
    .bg{position:fixed;inset:0;z-index:-2;background:
      radial-gradient(1200px 700px at 70% 30%,#0a1533 0%,#081229 45%,#060e22 70%,#050a1a 100%)}
    /* denser starfield */
    .stars{position:absolute;inset:0;opacity:.95;pointer-events:none;
      background-image:
        radial-gradient(1.8px 1.8px at 12% 18%,#9fb5ff99,transparent),
        radial-gradient(1.6px 1.6px at 22% 76%,#8aa4ff88,transparent),
        radial-gradient(1.2px 1.2px at 46% 32%,#a6b7ff77,transparent),
        radial-gradient(1.4px 1.4px at 66% 58%,#9db2ff66,transparent),
        radial-gradient(1.0px 1.0px at 82% 22%,#a9baff66,transparent),
        radial-gradient(1.2px 1.2px at 30% 88%,#8aa4ff66,transparent),
        radial-gradient(1.0px 1.0px at 74% 86%,#b6c3ff55,transparent);
      animation: twinkle 6s linear infinite;
    }
    @keyframes twinkle{0%,100%{opacity:.7}50%{opacity:1}}

    /* constellation canvas sits above bg, below content */
    #constellations{position:fixed;inset:0;z-index:-1;display:block}

    /* form card */
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:520px;background:rgba(17,24,39,.88);backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:28px 24px;box-shadow:0 10px 30px rgba(5,10,26,.55)}
    h1{font-size:24px;margin:0 0 18px;color:#e7ecff}
    form{display:grid;gap:12px}
    label{font-size:12px;color:#aab4cf}
    input{width:100%;padding:12px 14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#e7ecff;
      border-radius:10px;outline:none;transition:border .15s,box-shadow .15s}
    input::placeholder{color:#9aa6c7}
    input:focus{border-color:#7ea2ff;box-shadow:0 0 0 3px rgba(79,124,255,.25)}
    .row{display:flex;gap:10px}
    .submit{background:#1a2b56;color:#fff;border:0;border-radius:12px;padding:12px 16px}
    .submit:hover{background:#152349}
    .hint{font-size:12px;color:#9aa6c7;margin-top:8px}
    .topnav{position:fixed;left:0;top:0;width:100%;padding:12px 16px;color:#a9b0c6}
    .topnav a{color:#c6cee6;text-decoration:none}
    /* custom dark segmented control instead of native select */
    .segmented{display:flex;gap:0;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);border-radius:12px;overflow:hidden}
    .segmented button{flex:1;padding:12px 14px;background:transparent;color:#e7ecff;border:0;cursor:pointer}
    .segmented button:hover{background:rgba(255,255,255,.08)}
    .segmented button.active{background:#1a2b56}

    /* success animation overlay (after choosing Register) */
    .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,#e9f0ff 0%,#f5f8ff 100%);}
    .overlay.show{display:flex;animation:fade .25s ease-out}
    @keyframes fade{from{opacity:0}to{opacity:1}}
    .pulse::after{content:"";width:92px;height:92px;border-radius:50%;background:#fff}
    .check{position:absolute;width:48px;height:48px;border-radius:50%;background:#4f7cff;display:grid;place-items:center;color:#fff;font-weight:700;font-size:28px;}

    /* responsive */
    @media (max-width: 560px){ .card{padding:22px 18px} }
  </style>
</head>
<body>
  <div class="topnav"><a href="/">← Назад</a></div>
  <div class="bg"><div class="stars"></div></div>
  <canvas id="constellations"></canvas>
  <div class="wrap">
    <div class="card">
      <h1>Вход или регистрация</h1>
      <form id="authForm" action="/auth/local" method="post">
        <div>
          <label for="email">Email</label>
          <input type="email" id="email" name="email" placeholder="you@example.com" required />
        </div>
        <div>
          <label for="password">Пароль</label>
          <input type="password" id="password" name="password" placeholder="•••••••" minlength="6" required />
        </div>
        <div id="confirmWrap" style="display:none">
          <label for="confirm">Подтвердите пароль</label>
          <input type="password" id="confirm" name="confirm" placeholder="•••••••" />
        </div>
        <div class="row">
          <input type="hidden" id="modeInput" name="mode" value="login" />
          <div class="segmented" role="tablist" aria-label="mode">
            <button type="button" data-mode="login" class="active">Войти</button>
            <button type="button" data-mode="register">Зарегистрироваться</button>
          </div>
          <button class="btn submit" type="submit" style="flex:1">Продолжить</button>
        </div>
        <div class="row" style="justify-content:space-between">
          <label style="display:inline-flex;align-items:center;gap:8px;color:#aab4cf">
            <input type="checkbox" name="remember" /> Запомнить меня
          </label>
          <a href="/forgot" style="color:#9db0ff">Забыли пароль?</a>
        </div>
        <div id="formError" class="hint" style="display:none;color:#ff9b9b"></div>
      </form>
      <div class="hint">Пароли хранятся локально в SQLite на этом сервере (только для разработки/теста).</div>
    </div>
    <div id="overlay" class="overlay">
      <div class="pulse"></div>
      <div class="check">✓</div>
    </div>
  </div>

  <script>
    // Покажем короткую анимацию перед отправкой формы при регистрации
    const form = document.getElementById('authForm');
    const overlay = document.getElementById('overlay');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const mode = fd.get('mode');
      const pwd = (fd.get('password')||'').toString();
      const conf = (fd.get('confirm')||'').toString();
      const err = document.getElementById('formError');
      if (err) { err.style.display = 'none'; err.textContent = ''; }
      // client checks
      if (mode === 'register') {
        if (pwd.length < 6){ if (err){ err.textContent='Минимальная длина пароля 6 символов'; err.style.display='block'; } return; }
        if (pwd !== conf){ if (err){ err.textContent='Пароли не совпадают'; err.style.display='block'; } return; }
        overlay.classList.add('show');
        await new Promise(r=> setTimeout(r, 700));
      }
      try{
        const res = await fetch('/auth/local', { method: 'POST', body: fd, credentials: 'include' });
        if(res.redirected){ window.location.assign(res.url); return; }
        if(!res.ok){ const text = await res.text(); if (err){ err.textContent = text || 'Ошибка'; err.style.display='block'; } overlay.classList.remove('show'); return; }
        // Fallback
        window.location.assign('/app');
      }catch(ex){ if (err){ err.textContent = 'Сеть недоступна'; err.style.display='block'; } overlay.classList.remove('show'); }
    });

    // Сегмент-переключатель вместо select
    (function(){
      const modeInput = document.getElementById('modeInput');
      const seg = document.querySelector('.segmented');
      const confirmWrap = document.getElementById('confirmWrap');
      const confirmInput = document.getElementById('confirm');
      function sync(){
        const isReg = modeInput.value === 'register';
        if(confirmWrap){ confirmWrap.style.display = isReg ? '' : 'none'; }
        if(confirmInput){ confirmInput.required = isReg; }
      }
      if(seg){
        seg.addEventListener('click', (e)=>{
          const btn = e.target.closest('button[data-mode]');
          if(!btn) return;
          seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          modeInput.value = btn.dataset.mode;
          sync();
        });
        // начальная синхронизация
        sync();
      }
    })();

    // Констелляции: анимированные точки и линии (адаптивная плотность под любое разрешение)
    (function(){
      const canvas = document.getElementById('constellations');
      const ctx = canvas.getContext('2d');
      let W = window.innerWidth;
      let H = window.innerHeight;
      const DPR = Math.max(1, window.devicePixelRatio || 1);
      function setSize(){
        canvas.width = Math.floor(W * DPR);
        canvas.height = Math.floor(H * DPR);
        canvas.style.width = W+'px';
        canvas.style.height = H+'px';
        ctx.setTransform(1,0,0,1,0,0);
        ctx.scale(DPR, DPR);
      }
      setSize();

      function targetCount(){
        // Плотность: 1 точка на ~12k px^2, но с минимумом/потолком
        const base = Math.floor((W*H)/12000);
        return Math.max(120, Math.min(320, base));
      }
      let MAX_LINK = 120; // адаптивная длина связи
      let nodes = [];
      function spawn(){
        return {
          x: Math.random()*W,
          y: Math.random()*H,
          vx: (Math.random()-.5)*0.25,
          vy: (Math.random()-.5)*0.25,
          r: 1.1 + Math.random()*1.8,
          a: 0.55 + Math.random()*0.35
        };
      }
      function ensureNodes(){
        const want = targetCount();
        if(nodes.length < want){
          for(let i=nodes.length;i<want;i++) nodes.push(spawn());
        } else if(nodes.length > want){
          nodes.length = want;
        }
        // Связи чуть длиннее на больших экранах
        MAX_LINK = Math.max(110, Math.min(180, Math.sqrt(W*H)/22));
      }
      ensureNodes();
      let mouse = {x: W*0.5, y: H*0.45};

      function step(){
        ctx.clearRect(0,0,W,H);
        // draw links
        for(let i=0;i<nodes.length;i++){
          const n = nodes[i];
          n.x += n.vx; n.y += n.vy;
          if(n.x<0||n.x>W) n.vx*=-1;
          if(n.y<0||n.y>H) n.vy*=-1;
        }

        // connections
        ctx.lineWidth = 1.1;
        for(let i=0;i<nodes.length;i++){
          for(let j=i+1;j<nodes.length;j++){
            const a = nodes[i], b = nodes[j];
            const dx = a.x-b.x, dy = a.y-b.y;
            const d = Math.hypot(dx,dy);
            if(d<MAX_LINK){
              const alpha = (1 - d/MAX_LINK) * 0.38;
              ctx.strokeStyle = `rgba(160,180,255,${alpha})`;
              ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
            }
          }
        }
        // points
        for(const p of nodes){
          const dx = p.x - mouse.x, dy = p.y - mouse.y; // лёгкий параллакс
          const par = 1 + Math.min(0.25, (90/Math.hypot(dx,dy+0.0001)));
          ctx.fillStyle = `rgba(200,210,255,${p.a})`;
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r*par, 0, Math.PI*2); ctx.fill();
        }
        requestAnimationFrame(step);
      }
      step();

      window.addEventListener('resize', () => {
        W = window.innerWidth; H = window.innerHeight;
        setSize();
        ensureNodes();
      });
      window.addEventListener('mousemove', (e)=>{ mouse.x = e.clientX; mouse.y = e.clientY; });
    })();
  </script>
</body>
</html>
